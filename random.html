<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Album Picker</title>
    <style>
        .loading {
            display: none;
        }
        .button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #1DB954;
            color: white;
            text-decoration: none;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="itemName"></h1>
        <img id="coverImage" src="" alt="Album cover" style="max-width: 300px;">
        <p id="artistName"></p>
        <a id="spotifyLink" class="button" target="_blank">Open in Spotify</a>
        <button id="rollAgain" class="button">Roll Again</button>
    </div>

    <div id="loading" class="loading">Loading...</div>

    <script>
        const CACHE_KEY = 'albumCache';
        const VERSION_KEY = 'albumCacheVersion';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz63RX2kvrxaeNYwi8LnW5NBqiRY3LRmff3E-cMeFFXiaNFY6W7tGOMfs4UKpwBCwCm/exec'; // Replace with your actual script URL
        
        let albumStack = [];

        async function getRandomAlbum() {
            showLoading(true);
            if (albumStack.length < 5) {
                await refreshAlbumStack();
            }
            
            if (albumStack.length > 0) {
                const album = albumStack.pop();
                displayAlbum(album);
                localStorage.setItem(CACHE_KEY, JSON.stringify(albumStack));
            } else {
                document.getElementById('itemName').textContent = 'No albums available';
            }

            showLoading(false);
            // Check for updates in the background
            checkForUpdates();
        }

        async function refreshAlbumStack() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getAll&type=album`);
                const data = await response.json();
                albumStack = data.items;
                localStorage.setItem(CACHE_KEY, JSON.stringify(albumStack));
                localStorage.setItem(VERSION_KEY, data.version);
            } catch (error) {
                console.error('Error refreshing album stack:', error);
            }
        }

        async function checkForUpdates() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=checkVersion`);
                const data = await response.json();
                const currentVersion = localStorage.getItem(VERSION_KEY);
                if (data.version !== currentVersion) {
                    await refreshAlbumStack();
                }
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }

        function displayAlbum(album) {
            document.getElementById('itemName').textContent = album.name;
            document.getElementById('artistName').textContent = `Artist: ${album.artist}`;
            document.getElementById('coverImage').src = album.coverUrl;
            document.getElementById('coverImage').alt = `${album.name} cover`;
            document.getElementById('spotifyLink').href = album.spotifyUrl;
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        document.getElementById('rollAgain').addEventListener('click', getRandomAlbum);

        // Initialize
        window.addEventListener('load', async () => {
            const cachedAlbums = localStorage.getItem(CACHE_KEY);
            if (cachedAlbums) {
                albumStack = JSON.parse(cachedAlbums);
            }
            await getRandomAlbum();
        });
    </script>
</body>
</html>